# Create a initial repository using nx

## Overview

This intent of this guide is NOT to create a high fidelity replica of this repo with all it's apps and libraries. 
Instead it's intended as a guide to create _your own repo_ that has:

* a publishable npm library
* a demo application
* reference document generated by [compodoc](https://compodoc.app/)
* documentation by example using [storybook](https://storybook.js.org/docs/angular/get-started/introduction)

When following the steps below to create _your own repo_:

* replace 'static-web-apps-auth' with the name of your repository
* replace 'christianacca' with the npm scope of the library you want to publish
* replace 'angular-swa-auth' with the name of your library

## Scaffold repository

1. Create the initial workspace

   Use nx tools to generate the workspace:

   ```bash
   npx create-nx-workspace@latest static-web-apps-auth --preset=empty --cli=angular --npm-scope=christianacca --interactive=false --nx-cloud=false
   cd ./static-web-apps-auth
   npm set-script nx "nx"
   ```

2. Create the demo app

   Use nx tools to generate the app:

   ```bash
   npm install -D @nrwl/angular
   npx ng g @nrwl/angular:application angular-swa-auth-demo --routing --style scss --inline-style --prefix app --tags=scope:angular-swa-auth-demo,framework:angular
   ```

   In angular.json (or apps/angular-swa-auth-demo/project.json if that exists), enable source maps for production:

   ```json
   {
     // snip
     "build": {
       // snip
       "configurations": {
         "production": {
           "sourceMap": true
           // snip
         }
       }
     }
   }
   ```
   
   To confirm setup run `npm start`. Browse to <http://localhost:4200> you should see the generated angular app site
   
3. Create the publishable library

   Use nx tools to generate the library:
   
   ```bash
   npx ng g @nrwl/angular:lib angular-swa-auth --prefix swa --tags=scope:public,type:util,framework:angular,bundle:main --style scss --simple-module-name --publishable --importPath=@christianacca/angular-swa-auth
   ```

   To confirm setup run: `npn run build angular-swa-auth`. Your library package should now be found at 'dist/libs/angular-swa-auth'

4. Add library documentation using [storybook](https://storybook.js.org/docs/angular/get-started/introduction)

   Use nx tools to add storybook configuration:
   
   ```bash
   npx nx g @nrwl/storybook:configuration angular-swa-auth --configure-cypress=false --ui-framework=@storybook/angular
   ```

   To confirm setup run: `npx nx storybook angular-swa-auth`. Browse to <http://localhost:4400> you should see the generated storybook site

5. Add library documentation using [compodoc](https://compodoc.app/)

   **IMPORTANT**: as of writing @twittwer/compodoc nx plugin does not support per-project configuration

   Use nx tools to add compodoc configuration:

   ```bash
   npx nx add @twittwer/compodoc
   npx nx g @twittwer/compodoc:config angular-swa-auth
   npx nx format # <- because @twittwer/compodoc messes up on formatting!
   ```

   Add convenience nx commands to run to serve and watch documentation generated by compodoc:

   ```bash
   npx nx g @nrwl/workspace:run-commands serve-compodoc --project angular-swa-auth --command 'nx compodoc angular-swa-auth --serve'
   npx nx g @nrwl/workspace:run-commands watch-compodoc --project angular-swa-auth --command 'nx compodoc angular-swa-auth --serve --watch'
   ```

   To confirm setup run: `npx nx serve-compodoc angular-swa-auth`. Browse to <http://localhost:8080> you should see the generated docs site

6. Convert to per-project configuration

   **IMPORTANT**: This step is only required if the tooling created a workspace using the v1 format

   Open angular.json and change as necessary: `"version": 1` to `"version": 2`, then run:
   
   ```bash
   npx nx format
   npx nx g @nrwl/workspace:convert-to-nx-project --all
   ```
   
7. Add Azure functions as your api

   Use VSCode tooling to generate the app:

   * Open static-wev-apps-auth in VSCode
   * Install VSCode Azure functions extension
   * Create a subfolder named api
   * Use the extension to create a new functions app. When prompted:
     1. Use the Browse option to select api folder to create the new function app
     2. Select typescript as the language
     3. Select "HTTP Trigger" for the first function
     4. Select "Anonymous" for the Authorization level for the new function
  
   Locally install Azure Functions Core Tools:

   ```bash
   npm install azure-functions-core-tools -D  # <- make sure current working directory is at the root of the repo
   ```

   To confirm setup run: `npm start`. Browse to <http://localhost:7071/api/HttpTrigger1> you should see a response from the functions app

## Setup tooling for local dev

1. Azure functions app tooling

   Note: the following commands require npm version 7

   Support for watching source code changes and triggering rebuild (aka "Edit and continue"):

   ```bash
   npm install npm-run-all -D  # <- make sure current working directory is at the root of the repo
   cd ./api
   npm install
   npm set-script watch "tsc -w"
   npm set-script start:host "func start"
   npm set-script start "npm-run-all --parallel start:host watch"
   ```
   
2. Create a self-signed certificate

   1. Add the scripts to generate a certificate:

      - tools/cert-gen
      - tools/dev-scripts
  
   2. Generate the certificate. In a powershell prompt: `./tools/dev-scripts/create-cert.ps1`
  
   3. Trust the certificate. In a powershell prompt: `./tools/dev-scripts/trust-cert.ps1`
   
3. Azure static web app emulator
   
   Add swa configuration files (one for prod and one local dev). See the files:
   
   * apps/angular-swa-auth-demo/staticwebapp.config.json
   * apps/angular-swa-auth-demo/dev/staticwebapp.config.json
  
   *(review `routes` configuration block of the files you've copied and adjust your demo app's specific requirements)*

   Locally install the emulator:

   ```bash
   npm install @azure/static-web-apps-cli -D # <- make sure current working directory is at the root of the repo
   ```
   
   Add command to serve angular app and swa emulator:

   ```bash
   npx nx g @nrwl/workspace:run-commands serve-swa --project angular-swa-auth-demo --command "swa start http://localhost:4200 --run 'npm start' --api http://localhost:7071 --swa-config-location ./apps/angular-swa-auth-demo/dev --ssl-cert=./tools/certs/localhost.crt --ssl-key=./tools/certs/localhost.key --ssl"
   ```

   Add convenience npm script to run api, angular app and swa emulator:

   ```bash
   npm set-script start:api "cd ./api && npm start"
   npm set-script start:swa "nx serve-swa"
   npm set-script start:demo "npm-run-all --parallel start:api start:swa"
   ```
   
   Note: `set-script` requires npm v7 or above

   To confirm setup:
   
   - `npm run start:demo`
   - Browse to <https://localhost:4080> you should see the generated angular app site
   - Browse to <https://localhost:4280/.auth/login/github> you should see an emulated login page
   - Browse to <https://localhost:4080/api/HttpTrigger1> you should see a response from the functions app
   
3. VS Code tooling
   
   Change VSCode configuration so that you can run/debug the demo app. Copy the files:

   - [tasks.json](.vscode/tasks.json)
   - [launch.json](.vscode/launch.json)

   To confirm setup in VS Code:
   
   * Press `F5`. This will launch Chrome at <https://localhost:4820/>.
   * Wait 10-20 seconds then refresh the browser page to see the generated angular app site
   * Set a breakpoint in both angular code and in the azure function and see VSCode hit those breakpoints
  
4. Jetbrains Rider tooling (if you use Rider as your IDE)

   Add Rider IDE configuration so that you can run/debug the demo app. Copy the files:

   - .run/start_ api.run.xml
   - .run/start_ demo.run.xml
   - .run/start_swa demo.run.xml

   To confirm setup in Rider:
   
   * Press `F9`
   * Set a breakpoint in the azure function 
   * Browse to <https://localhost:4820/> and see Rider hit the breakpoint

5. Adjust angular schematics

   In angular.json, ensure that the schematics for generating an angular component uses preferred defaults:

   ```json
   {
     "@nrwl/angular:component": {
       "style": "scss",
       "changeDetection": "OnPush",
       "displayBlock": true,
       "inlineStyle": true
     }
   }
   ```

## Create Azure static web apps

Use the Azure CLI to create three Azure static web apps:

* angular demo app site
* reference documentation site generated compoodc
* example documentation site generated by storybook

### Demo app

1. Create the Azure static web app

   Use [az cli](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli) to create the azure resource:
   
   ```bash
   az login
   az group create --location centralus --resource-group angular-swa-auth-demo
   az staticwebapp create \
     -n angular-swa-auth-demo \
     -g angular-swa-auth-demo \
     -s https://github.com/<YOUR_GITHUB_ACCOUNT_NAME>/static-web-apps-auth \
     -l centralus \
     -b master \
     --app-location "/" \
     --output-location "/dist/apps/angular-swa-auth-demo" \
     --api-location api \
     --login-with-github
   ```
   
   The above command will perform the following:
   
   * Create an Azure Static Web App resource
   * Create a github actions workflow in your github repo
   * Upload your demo app static assets to the Azure Static Web app service (github actions will perform this step)
   
   Once the above commands have completed successfully:
   
   * browse to the [Azure portal](https://portal.azure.com/) and search for **angular-swa-auth-demo** from the top search bar.
   * browse to your github repo and select the Actions tab to review the status of the github workflow that will publish the swa site
   
   Resources:
   
   * Official documentation for cli command: https://docs.microsoft.com/en-us/cli/azure/staticwebapp?view=azure-cli-latest#az_staticwebapp_create
   * More guidance on creating the Azure static web app: https://docs.microsoft.com/en-us/azure/static-web-apps/get-started-cli?tabs=angular

2. Fixup the github action parameters

   The az cli command does not currently support the `--config-file-location` parameter. If it had you would not need to perform this step.

   ```bash
   git pull
   ```

   In .github/workflows/azure-static-web-apps-{auto-generated-name-for-demo-app}.yml, find the section:

   ```yml
   ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
   # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
   app_location: "/"
   ```

   add the following parameters:

   ```yml
   config_file_location: "/apps/angular-swa-auth-demo"
   ```

   Push the change to trigger a rebuild and upload of the your docs site to Azure static web app:

   ```bash
   git add -A
   git commit -m "Fixup github actions workflow"
   git push
   ```

   To confirm setup in Azure + github:

   * wait for the github actions build to complete
   * browse to **angular-swa-auth-demo** Azure static web app in the [Azure portal](https://portal.azure.com/)
   * select the "Browse" menu and confirm that the page opened in the browser is the demo app


### Reference document site (compodoc)

1. Create the Azure static web app
   
   Use *az cli* to create the azure resource:

   ```bash
   az login
   az group create --location centralus --resource-group angular-swa-auth-docs
   az staticwebapp create \
     -n angular-swa-auth-docs \
     -g angular-swa-auth-docs \
     -s https://github.com/<YOUR_GITHUB_ACCOUNT_NAME>/static-web-apps-auth \
     -l centralus \
     -b master \
     --app-location "/" \
     --output-location "/dist/compodoc/angular-swa-auth" \
     --api-location "" \
     --login-with-github
   ```

   The above command will perform the following:
   
   * Create an Azure Static Web App resource
   * Create a github actions workflow in your github repo

   Currently the az cli does not currently support the full set of parameters we need to supply to the github action (you'll fix these up below).
   *As a consequence the initial github workflows build for the docs site will fail*

2. Fixup the github action parameters

   The az cli command does not currently support the following parameters: `--app-build-command`. If it had you would not need to perform this step.

   ```bash
   git pull
   ```

   In .github/workflows/azure-static-web-apps-{auto-generated-name-for-compodoc-site}.yml, find the section:

   ```yml
    ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
    # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
    app_location: "/"
   ```

   add the following parameters:

   ```yml
   app_build_command: "npx nx compodoc angular-swa-auth"
   ```

   Push the change to trigger a rebuild and upload of the your angular app to Azure static web app:

   ```bash
   git add -A
   git commit -m "Fixup github actions workflow"
   git push
   ```

   To confirm setup in Azure + github:
   
   * wait for the github actions build to complete
   * browse to **angular-swa-auth-docs** Azure static web app in the [Azure portal](https://portal.azure.com/)
   * select the "Browse" menu and confirm that the page opened in the browser is the compodoc site

### Examples document site (storybook)

1. Create the Azure static web app

   Use *az cli* to create the azure resource:

   ```bash
   az login
   az group create --location centralus --resource-group angular-swa-auth-stories
   az staticwebapp create \
     -n angular-swa-auth-stories \
     -g angular-swa-auth-stories \
     -s https://github.com/<YOUR_GITHUB_ACCOUNT_NAME>/static-web-apps-auth \
     -l centralus \
     -b master \
     --app-location "/" \
     --output-location "/dist/storybook/angular-swa-auth" \
     --api-location "" \
     --login-with-github
   ```

   The above command will perform the following:

   * Create an Azure Static Web App resource
   * Create a github actions workflow in your github repo

   Currently the az cli does not currently support the full set of parameters we need to supply to the github action (you'll fix these up below).
   *As a consequence the initial github workflows build for the docs site will fail*

2. Fixup the github action parameters

   The az cli command does not currently support the following parameters: `--app-build-command`. If it had you would not need to perform this step.

   ```bash
   git pull
   ```

   In .github/workflows/azure-static-web-apps-{auto-generated-name-for-storybook-site}.yml, find the section:

   ```yml
    ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
    # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
    app_location: "/"
   ```

   add the following parameters:

   ```yml
   app_build_command: "npx nx build-storybook angular-swa-auth"
   ```

   Push the change to trigger a rebuild and upload of the your angular app to Azure static web app:

   ```bash
   git add -A
   git commit -m "Fixup github actions workflow"
   git push
   ```

   To confirm setup in Azure + github:

   * wait for the github actions build to complete
   * browse to **angular-swa-auth-stories** Azure static web app in the [Azure portal](https://portal.azure.com/)
   * select the "Browse" menu and confirm that the page opened in the browser is the storybook site

## Setup deployment pipeline

At this point Azure static web apps service has partially created the CI/CD pipeline that we want. To complete the pipeline:

* Consolidate all the github/workflows files into a single workflow
* Change the build of each static web app: instead we want `nx tools` to do this and only for those sites that are affected by a commit
* Publish the library as an npm package

1. Create the consolidated github workflow

   * Add consolidated workflow yml file to repo. Copy .github/workflows/angular-swa-auth.yml then modify this copy as follows:
  
     * Delete the steps for the other "nolib" demo app (this guide does not deal with that other app):
        - `Check angular-swa-auth-nolib app affected`
        - `Deploy angular-swa-auth-nolib app`
        - `Delete angular-swa-auth-nolib PR environment`
     * Change the step `Run linting and builds` to remove the option `nxCloud: true`
     * Remove the step `Run e2e` (you'll add this back later in this guide)
     * Change the names `secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_{AUTO_GENERATED_NAME}` to match the names of the workflows generated by Azure static web apps service above. Do this for the demo, compodoc and storybook static web apps
     * *(if you are creating your own library, replace `angular-swa-auth` with the name of the library)*
   
   * Delete the original github workflow files:

     ```bash
     rm .github/workflows/azure-static-web-apps-*
     ```

   * Add to github repo a secret named `NPM_TOKEN`. This will hold an npm access token to allow github to publish your package. Follow this guide: https://sergiodxa.com/articles/github-actions-npm-publish#configure-the-secret

   * Push the change to trigger a rebuild and publish your package to npm:

     ```bash
     git add -A
     git commit -m "Fixup github actions workflow"
     git push
     ```
  
2. (Optional) Add distributed build cache

   This repo uses [`nx cloud`](https://nx.app/) to optimize the build and test cycle. It's optional, but well recommended
   (`nx cloud` offers a free tier and is completely free for open source)
   
   1. Following the instructions here: https://nx.app/docs/add-nx-cloud-to-workspace#adding-nx-cloud-to-an-existing-workspace
   2. Change the step `Run linting and builds` to add the option `nxCloud: true`

## Finishing touches

1. Install IDE recommended extensions

  * for VS Code see [here](.vscode/extensions.json)
  * for Jetbrains Rider see [here](README.md#Dev-machine-setup)

2. Add dev guidance

   * Add a [README.md](README.md) and [CONTRIBUTING.md](CONTRIBUTING.md) with an overview and development guide
   * Add [create-initial-repo.md](docs/create-initial-repo.md) to help others (or your future self) make their own repo
   * Add [add-library.md](docs/add-library.md) to provide guidance on deciding the type of library to create and assistance on generating the nx command
      * Make a copy of [library-command-generator](https://docs.google.com/spreadsheets/d/11yt4-Tmhq87nlnX6Tcba98HnGQJk42IOBQk4t7RUIfc/edit?usp=sharing) and adjust for the new repo 
  
3. Add library guidance

   * Add a [README.md](libs/angular-swa-auth/README.md)
   * Add a [CHANGELOG.md](libs/angular-swa-auth/CHANGELOG.md)
  

## Further help

- [Nx Documentation](https://nx.dev)
- [Nx Article](https://blog.ng-book.com/getting-started-with-nx-the-nrwl-extensions-for-angular/)
- [Azure Static Web Apps](https://docs.microsoft.com/en-us/azure/static-web-apps/overview)
